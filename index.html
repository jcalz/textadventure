<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ascii">
  <title>Text Adventure</title>
  <link href="https://fonts.googleapis.com/css?family=VT323" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA=" crossorigin="anonymous"></script>
  <script src="./adventure.js"></script>
  <style>
    * {
      font-family: 'VT323', monospace;
      font-variant-ligatures: none;
      box-sizing: border-box;
      margin: 0;
    }

    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      flex-flow: column nowrap;
      align-items: stretch;
      overflow: hidden;
    }

    .header {
      text-align: center;
    }

    .adventure-window {
      flex: 1;
      border: 5px solid #0f0;
      padding: 5px;
      color: #0f0;
      background-color: black;
      font-size: 1.5em;
      display: flex;
      flex-flow: column-reverse nowrap;
      overflow: hidden;
    }

    .output {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      overflow: auto;
    }

    .output-text {
      color: #ff0;
    }

    .error-text {
      color: #f00;
    }

    .alert-text {
      color: #f70;
    }

    .input-line {
      display: flex;
      flex-flow: row nowrap;
      flex: 0 0 auto;
    }

    #input {
      flex: 1;
      border: none;
      outline: none;
      color: #0f0;
      background-color: black;
      font-size: 1em;
    }

    .filler {
      height: 100vh;
      display: inline-block;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>Text Adventure Game</h1>
  </div>
  <div class="adventure-window">
    <form autocomplete="off" class="input-line" id="adventure-form" onsubmit="return false;">
      <label class="prompt" for="input">&gt;&gt;&nbsp;</label>
      <input type="text" id="input">
    </form>
    <div class="output" id="output">
      <span class="filler output-text"></span>
    </div>
  </div>

  <script>
    "use strict";

    function storageAvailable(type) {
      try {
        var storage = window[type],
          x = '__storage_test__';
        storage.setItem(x, x);
        storage.removeItem(x);
        return true;
      } catch (e) {
        return false;
      }
    }
    var hasLocalStorage = storageAvailable('localStorage');

    // USER INTERFACE
    function moveCaretToEnd(el) {
      if (typeof el.selectionStart == "number") {
        el.selectionStart = el.selectionEnd = el.value.length;
      } else if (typeof el.createTextRange != "undefined") {
        el.focus();
        var range = el.createTextRange();
        range.collapse(false);
        range.select();
      }
    }

    // NEVER ALLOW THE FOCUS TO LEAVE THE INPUT BOX!  (seems evil)
    $('#input').blur(function() {
      window.setTimeout(function() {
        $('#input').focus();
      }, 0);
    });
    // IMPLEMENT COMMAND HISTORY WITH UP AND DOWN ARROWS		
    var commandHistory = function() {
      var history = [];
      var localHistory = [''];
      var index = 0;
      var add = function add(command) {
        // don't add duplicates, don't add blanks		
        if (command.length && (!history.length || history[history.length - 1] !== command)) {
          history.push(command);
        }
        index = history.length;
        localHistory = history.slice();
        localHistory.push('');
      };
      var arrow = function arrow(up, command) {
        localHistory[index] = command;
        if (up) {
          index = Math.max(index - 1, 0);
        } else {
          index = Math.min(index + 1, history.length);
        }
        return localHistory[index];
      };
      return {
        add: add,
        arrow: arrow
      };
    }();
    var KEYCODE_UP = 38;
    var KEYCODE_DOWN = 40;
    $('#input').keydown(function(e) {
      if (e.which == KEYCODE_UP || e.which == KEYCODE_DOWN) {
        var inputText = $('#input').val();
        var selectedCommand = commandHistory.arrow(e.which == KEYCODE_UP, inputText);
        $('#input').val(selectedCommand);
        moveCaretToEnd($('#input').get(0));
        e.preventDefault();
      }
    });

    function output(str, classNames) {
      classNames = classNames || 'output-text';
      $('#output').queue(function(next) {
        //console.log(str);
        var outputSpan = $('<span>').addClass(classNames);
        outputSpan.text(str + '\n');
        var o = $('#output');
        o.scrollTop(o.get(0).scrollHeight);
        var startTop = o.scrollTop();
        o.append(outputSpan);
        var millisPerWindow = 500;
        var pixelsPerMilli = $(window).height() / millisPerWindow;
        var start = null;
        var step = function step(time) {
          if (!start) start = time;
          var top = startTop + pixelsPerMilli * (time - start);
          o.scrollTop(top);
          if (Math.abs(o.scrollTop() - top) < 1) {
            window.requestAnimationFrame(step);
          } else {
            next();
          }
        };
        window.requestAnimationFrame(step);
      });
    }

    function processInput(ioFunction) {
      try {
        var inputText = $('#input').val();
        commandHistory.add(inputText);
        $('#input').val('');
        output('>>\xA0' + inputText, 'input-text');
        var outputText = ioFunction(inputText);
        output(outputText + '\n');
      } catch (e) {
        output('ERROR: ' + JSON.stringify(e, Object.getOwnPropertyNames(e)) + '\n', 'error-text');
        if ("console" in window) console.log(e);
      }
    }

    function durationString(millis) {
      if (millis < 0) return null;
      var units = ['millisecond', 'second', 'minute', 'hour', 'day', 'week'];
      var divisors = [1000, 60, 60, 24, 7, 3];
      var t = millis;
      for (var i = 0; i < units.length; i++) {
        if (t < divisors[i]) {
          t = Math.floor(t);
          return t + ' ' + units[i] + (t == 1 ? '' : 's');
        }
        t = t / divisors[i];
      }
      return null;
    };

    function dateString(millis) {
      var date = new Date(millis);
      if (Intl && Intl.DateTimeFormat) {
        return (new Intl.DateTimeFormat('en-US', {
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        })).format(date);
      }
      return date.toString();
    };

    var gameVersion = '-thegame-v0.0.2';
    var autosaveKey = 'autosave' + gameVersion;

    $(function() {

      var processInputNormally = function() {
        $('#adventure-form').off('submit').submit(function() {
          processInput(function(inputText) {
            return you.adventure.respond(you, inputText);
          });
          if (hasLocalStorage) {
            localStorage.setItem(autosaveKey, adventure.serialize());
            localStorage.setItem(autosaveKey + '-time', Date.now());
          }
          return false;
        });

      }

      if (previouslySavedState) {
        output(
          '\n--------------------------------------PREVIOUS GAME AVAILABLE!--------------------------------------',
          'alert-text');
        var timestamp = parseInt(localStorage.getItem(autosaveKey + '-time'), 10);
        var ds = durationString(Date.now() - timestamp);
        var when = (timestamp) ? ((ds) ? (ds + ' ago') : ('on ' + dateString(timestamp))) : '';
        output('It looks like you left a game in progress ' + when + '.\n');
        output('Would you like to continue that game?');
        output('If you type "YES", you will continue the previous game where you left off.');
        output('If you type "NO", you will start a new game, and the previous game will be erased.');
        output('\nPlease type "YES" or "NO".\n');
        $('#adventure-form').submit(function() {
          processInput(function(inputText) {
            var i = inputText.replace(/[\s"']/g, '').toLowerCase();
            if ((i !== 'yes') && (i !== 'no'))
              return 'Please type \"YES\" or \"NO\".';
            var ret;
            if (i === 'yes') {
              adventure.deserialize(previouslySavedState);
              ret = '\n' + 'Okay, continuing the previous game...\n\n' + you.look();
            } else {
              ret = '\nOkay, starting a new game...\n\n' + you.start();
              localStorage.removeItem(autosaveKey);
            }
            processInputNormally();
            return ret;
          });
          return false;
        });

      } else {
        output('\n' + you.start());
        processInputNormally();
      }

      $('#input').focus();

    });

    ///////////// SPECIFIC STUFF /////////////////
    var A = Adventure;
    var adventure = A.newAdventure();

    var you = {};
    you.id = 'you';
    you.name = 'you';
    you.keywords = ['me', 'myself', 'I'];
    you.known = true;
    you.unlisted = true;
    you.plural = true; // I think this works for second person
    you.it = 'you'; 
    you = adventure.newPerson(you);

    // silly template language: 
    // "use %i1" means "use" followed by an ITEM, to be passed as FIRST parameter to the function.
    // "give %i1 to %i2", means "give"
    // "go %d1" // d means DIRECTION
    you.addCommand('read', 'beReadBy', ['read %i1'], 'Read something.');
    you.addCommand('eat', 'beEatenBy', ['eat %i1']);
    you.addCommand('open', 'beOpenedBy', ['open %i1', 'open %i1 with %i2', 'use %i2 to open %i1', 'open %i1 using %i2']);
    you.addCommand('close', 'beClosedBy', ['close %i1', 'shut %i1']);
    you.addCommand('unlock', 'beUnlockedBy', ['unlock %i1', 'unlock %i1 with %i2', 'use %i2 to unlock %i1',
      'unlock %i1 using %i2'
    ]);
    you.addCommand('lock', 'beLockedBy', ['lock %i1', 'lock %i1 with %i2', 'use %i2 to lock %i1', 'lock %i1 using %i2']);
    you.addCommand('move', 'beMovedBy', ['move %i1']);
    you.addCommand('push', 'bePushedBy', ['push %i1', 'shove %i1', 'press %i1', 'push on %i1', 'press on %i1']);
    you.addCommand('pull', 'bePulledBy', ['pull %i1', 'tug %i1', 'yank %i1', 'pull on %i1', 'tug on %i1', 'yank on %i1']);
    you.addCommand('putInto', 'bePutIntoBy', ['put %i2 into %i1','put %i2 in %i1','put %i2 inside %i1','place %i2 into %i1','place %i2 in %i1','place %i2 inside %i1']);
    
    // PLACES
    var room = {
      id: 'room'
    };
    room.description = 'You are standing in a room with four walls, no furniture, and no windows.';
    room = adventure.newPlace(room);

    var closet = {
      id: 'closet'
    };
    closet.description = 'You are standing inside of a closet. It is dim in here.  There is a heavy ' +
      'boulder up against the eastern wall.';

    closet = adventure.newPlace(closet);

    var tunnel = adventure.newPlace({
      name: "underground tunnel",
      id: "tunnel",
      description: 'You find yourself in an underground tunnel that you can stand in and walk. ' +
        'The walls of the tunnel are made out of stone.',
      keywords: ["tunnel", "underground tunnel"]

    });

    var pit = adventure.newPlace({
      id: "pit",
      description: 'You are now at the bottom of a pit.  This pit is very deep.  The walls of the pit are also made of stone.'
    });

    var bedroom = adventure.newPlace({
      id: "bedroom",
      description: 'This room is big, with a huge bed covered in pink blankets.',
    });

    // EXITS
    adventure.newExit(Object.assign({}, Adventure.openableExitOptions, {
      name: 'door',
      keywords: ['door', 'exit'],
      location: room,
      direction: 'north',
      destination: closet,
      reverse: true
    }));

    adventure.newExit(Object.assign({}, Adventure.openableExitOptions, {
      name: 'door',
      keywords: ['door', 'exit'],
      location: bedroom,
      direction: 'north',
      destination: room,
      reverse: true
    }));

    var holeInTheWall = adventure.newExit({
      id: 'holeInTheWall',
      name: 'hole',
      keywords: ['hole', 'exit'],
      description: 'It\'s just a large hole in the wall; no big deal.',
      location: closet,
      direction: 'east',
      destination: tunnel,
      reverse: true,
      hidden: true
    });

    adventure.newExit({
      location: tunnel,
      name: 'ramp',
      keywords: ['ramp', 'exit'],
      direction: 'east',
      destination: pit,
      reverse: 'up'
    });

    you.location = room;

    // ITEMS
    var canOpener = {
      id: 'can opener'
    }
    canOpener.keywords = ['can opener', 'opener'];
    canOpener.beUsedBy = function(subject, object) {
      if (!object) {
        if (subject.has(soup)) {
          return subject.open(soup, this);
        }
        if (!subject.has(this)) {
          return "You don't have " + this.definiteName + ".";
        }
        return "You can't use " + this.definiteName + " now.";
      }
      return subject.open(object, this);
    };
    canOpener.location = tunnel;
    canOpener = adventure.newItem(canOpener);
    
    var soup = {
      id: 'can of soup'
    }
    soup.keywords = ['can of soup', 'can', 'soup', 'soup can', 'soupcan'];
    soup.closed = true;
    soup.full = true;
    soup.beExaminedBy = function(subject) {
      if (!subject.has(this)) {
        return "It just looks like a can of soup from here.  Maybe you can examine it more closely if you pick it up.";
      }
      var ret = "The can is labeled \"NASS-TEE Split Pea Soup\". ";
      if (soup.closed) {
        ret += 'It is sealed shut.';
      } else if (soup.full) {
        ret += 'It is open and full of soup.';
      } else {
        ret += 'It is empty.';
      }
      return ret;
    };
    soup.beOpenedBy = function(subject, instrument) {
      if (!subject.has(this)) {
        return "You don't have " + this.definiteName + ".";
      }
      if (!this.closed) {
        return A.capitalize(this.definiteName) + " has already been opened.";
      }
      if (!instrument) {
        return "You try to rip the soup can open with your bare hands, but you can't.";
      }
      if (instrument !== canOpener) {
        return "You can't use " + instrument.definiteName + " to open " + this.definiteName + ".";
      }
      if (!subject.has(instrument)) {
        return "You don't have " + instrument.definiteName + ".";
      }
      this.closed = false;
      return "You successfully use " + instrument.definiteName + " to open " + this.definiteName + ".";
    }
    soup.beReadBy = function(subject) {
      if (!subject.has(this)) {
        return "It looks like there's writing on it, but you can't read it from here.";
      }
      return 'The soup can label is partially ripped off.  The part that\'s still there reads:\n' +
        '"NASS-TEE Split Pea Soup\n\n  If you like squished-up peas, you\'re sure to love these!\n' +
        '  Plop it in a bowl, or eat the can whole!\n' + '  It goes in as soup, but comes out as "';
    };
    soup.beUsedBy = function(subject, instrument) {
      if (!subject.has(this)) {
        return "You don't have " + this.definiteName + ".";
      }
      if (this.closed) {
        return this.beOpenedBy(subject, instrument);
      }
      if (!this.full) {
        return "You can't use the empty soup can.";
      }
      return this.beEatenBy(subject, instrument);
    };
    soup.beEatenBy = function(subject) {
      if (!subject.has(this)) {
        return "You have to pick up " + this.definiteName + " to eat it.";
      }
      if (this.closed) {
        return "You can't eat the sealed can.";
      }
      if (this.full) {
        this.full = false;
        return "You eat the soup.  Yum, tasty room-temperature soup!";
      }
      return "You can't eat it; the can is empty.";
    };
    soup.location = closet;
    soup = adventure.newItem(soup);
   
    var note = {
      'id': 'note'
    };
    note.location = 'pit';
    note.beExaminedBy = function(subject) {
      if (!subject.has(this)) {
        return "It appears to have some writing on it, but you can't read it if you don't have it.";
      }
      return "There's definitely writing on it.";
    };
    note.beReadBy = function(subj) {
      if (!subj.has(this)) {
        return "You can't read it if you don't have it.";
      }
      return "The note reads:\n\n" +
        "\"Dear Mom,\n\nPlease do not eat the yummy NASS-TEE Split Pea Soup. I am saving it for dinner.\n" +
        "Love,\nElla.\"";
    };
    var note = adventure.newItem(note);

    var bed = {
      id: 'bed'
    };
    bed.unlisted = true;
    bed.beExaminedBy = function(subject) {
      var ret = 'The bed is huge with pink blankets and purple pillows.';
      if (teddyBear.location === bed.location) {
        teddyBear.hidden = false; // reveal the teddy bear
        teddyBear.known = true;
        ret += ' There is a teddy bear on the bed.';
      }
      return ret;
    };
    bed.canBeTaken = false;
    bed.beUsedBy = function(subject) {
      return "You lie down on the bed and fall asleep for a few minutes.  You wake up feeling refreshed.";
    };
    bed.location = bedroom;
    bed = adventure.newItem(bed);
    
    bedroom.newBackgroundItem({
      name: 'pillows',
      plural: true,
      keywords: ['pillow', 'pillows']
    });
    bedroom.newBackgroundItem({
      name: 'blankets',
      plural: true,
      keywords: ['blanket', 'blankets']
    });

    var teddyBear = {
      id: 'teddy bear'
    };
    teddyBear.keywords = ['teddy bear', 'teddybear', 'teddy', 'bear'];
    teddyBear.hidden = true;
    teddyBear.beExaminedBy = function(subject) {
      if (!subject.has(teddyBear)) {
        return 'The teddy bear is brown and wearing green overalls. You can\'t tell anything else about it from here.';
      }
      var ret = 'The teddy bear is brown and furry.  ' +
        'It is wearing green corduroy overalls with a pocket in the front.';
      if (key.location === this) {
        ret += ' You notice a key sticking out of the pocket.';
        key.known = true;
      }
      return ret;
    }
    teddyBear.location = bedroom;
    teddyBear = adventure.newItem(teddyBear);

    var key = {
      id: 'key'
    };
    key.keywords = ['key'];
    key.beUsedBy = function(subject, object) {
      if (!object) {
        return "I don't know how you want to use the key.  Try using it on something.";
      }
      if (object === cabinet)
        return subject.unlock(object, this);
      if (!subject.canSee(object)) {
        return "You can't see " + object.definiteName + ".";
      }
      return "You try to use the key on " + object.definiteName + " but it doesn't do anything.";
    }
    key.location = teddyBear;
    key = adventure.newItem(key);

    var cabinet = {
      id: 'cabinet'
    };
    cabinet.keywords = ['cabinet'];
    cabinet.locked = true;
    cabinet.canBeTaken = false;
    cabinet.beExaminedBy = function(subject) {
      var ret = 'The cabinet is made out of wood.';
      if (cabinet.locked) {
        ret += ' It is closed and locked.';
      } else {
        ret += ' It is open ';
        var items = cabinet.listContents().map(function(it) {
          return it.indefiniteName;
        });
        if (items.length == 0) {
          ret += 'and empty.';
        } else {
          ret += 'and contains ' + A.series(items) + ".";
        }
      }
      return ret;
    };
    cabinet.beOpenedBy = cabinet.beUnlockedBy = cabinet.bePulledBy = function(subject, instrument) {
      if (!cabinet.locked) {
        return "The cabinet is already open.";
      }
      if (!instrument) {
        return "You try to open the cabinet but it remains locked.";
      }
      if (!subject.has(instrument)) {
        return "You don't have " + instrument.definiteName + ".";
      }
      if (instrument !== key) {
        return "You try to open the cabinet with " + instrument.definiteName + " but it remains locked.";
      }
      cabinet.locked = false;
      return "You turn the key in the cabinet's lock until you hear a click.  The cabinet springs open!";
    }
    cabinet.bePutIntoBy = function(subject, item) {
        if (!subject.has(item)) {
            return "You don't have "+item.definiteName+".";
        }        
        item.location = this;
        return "You have put "+item.definiteName+" in "+this.definiteName+".";
    };
    cabinet.location = bedroom;
    cabinet = adventure.newItem(cabinet);

    var diary = {
      id: 'diary'
    };
    diary.keywords = ['diary'];
    diary.description = 'The cover is labelled "Ella\'s Diary: PRIVATE, DO NOT READ!"';
    diary.beReadBy = function(subject) {
      if (!subject.has(this)) {
        return 'You can\'t read it from here.';
      }
      return "You open the diary and begin to read.  It says:\n" +
        "  \"Dear Diary,\n" +
        "   I'm really excited.  I'm going to my friend's house.  My friend is Emma Watson." +
        " I don't think my friend's parents like me very much. But they seemed very excited " +
        "when I told them I was rich.\"";
    }
    diary.location = cabinet;
    diary = adventure.newItem(diary);

    var boulder = {
      id: 'boulder'
    }
    boulder.keywords = ['boulder', 'bolder', 'rock', 'heavy boulder'];
    boulder.unlisted = true;
    boulder.canBeTaken = false;
    boulder.budged = false;
    boulder.description = "This boulder is much too heavy for you to pick up.  " +
      "You might be able to move it a little, but that's about it.";
    boulder.beMovedBy = function(subject) {
      var ret = "";
      if (!boulder.budged) {
        boulder.budged = true;
        holeInTheWall.hidden = false;
        holeInTheWall.known = true;
        return "You bend down and push the boulder as hard as you can.  At first, it won't budge. " +
          "Finally, it starts moving along the wall, little by little.  Eventually you push it into " +
          "the corner where it stays.  You can't move it any further, and now you're sweaty and tired. " +
          "Why did you do this again?\n\nAnnoyed with yourself, you step back from the boulder and stand " +
          "up again... to see that the boulder had been blocking a large hole in the eastern wall, which is now " +
          "revealed!"
      }
      return "The boulder is completely wedged in the corner now.  It's not going anywhere.";
    }
    boulder.bePushedBy = boulder.beMovedBy;
    boulder.bePulledBy = boulder.beMovedBy;
    boulder.location = closet;
    boulder = adventure.newItem(boulder);

    /*
    var magicEye = adventure.newItem("magic eye");
    magicEye.keywords = ['eye','magic eye','magic'];
    magicEye.location = room;
    pit.beExaminedBy = function(subject) {
      if (!subject.has(magicEye)) {
        return "YOU CANNOT SEE ANYTHING WITHOUT THE MAGIC EYE";
        }
      return this.superMethod('beExaminedBy')(subject);
    }        
    */

    var initialState = adventure.serialize();
    var previouslySavedState = hasLocalStorage && localStorage.getItem(autosaveKey);

    var started = false;
    you.start = function() {
      var ret = "";
      if (started) {
        ret += "Okay, restarting the game from the beginning...\n\n";
        adventure.deserialize(initialState);
      }
      started = true;
      ret +=
        "You have walked into a humongous house.  As you walk into a room, the door slams shut behind you and is now gone." +
        "  Welcome to the game.\n\n" + you.look();
      return ret;
    };
    you.start.templates = ['restart the game'];
    you.start.help = 'Go back to the beginning of the game.  Clears everything.  Be careful!';
  </script>
</body>

</html>